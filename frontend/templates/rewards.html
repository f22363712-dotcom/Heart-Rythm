{% extends 'base.html' %}

{% block title %}å¥–åŠ±ç®¡ç†{% endblock %}

{% block content %}
    <h2>ğŸ å¥–åŠ±ç®¡ç†</h2>
    
    <div class="card">
        <h3>æ·»åŠ æ–°å¥–åŠ±</h3>
        <form id="addRewardForm">
            <div class="form-group">
                <label for="rewardId">å¥–åŠ±ID</label>
                <input type="text" id="rewardId" name="reward_id" required placeholder="ä¾‹å¦‚ï¼šreward001">
            </div>
            <div class="form-group">
                <label for="rewardName">å¥–åŠ±åç§°</label>
                <input type="text" id="rewardName" name="name" required placeholder="å¥–åŠ±åç§°">
            </div>
            <div class="form-group">
                <label for="pointsNeeded">æ‰€éœ€ç§¯åˆ†</label>
                <input type="number" id="pointsNeeded" name="points_needed" required placeholder="å…‘æ¢æ‰€éœ€ç§¯åˆ†" min="1">
            </div>
            <div class="form-group">
                <label for="stock">åº“å­˜</label>
                <input type="number" id="stock" name="stock" required placeholder="å¥–åŠ±åº“å­˜" min="0">
            </div>
            <div class="form-group">
                <label for="description">æè¿°</label>
                <textarea id="description" name="description" placeholder="å¥–åŠ±æè¿°" rows="3"></textarea>
            </div>
            <button type="submit" class="btn">æ·»åŠ å¥–åŠ±</button>
        </form>
        <div id="addRewardResult" style="margin-top: 15px;"></div>
    </div>
    
    <div class="card">
        <h3>ç§¯åˆ†å˜åŠ¨</h3>
        <form id="pointsChangeForm">
            <div class="form-group">
                <label for="changeCoupleId">æƒ…ä¾£ID</label>
                <input type="text" id="changeCoupleId" name="couple_id" required placeholder="è¾“å…¥æƒ…ä¾£ID">
            </div>
            <div class="form-group">
                <label for="pointsChange">ç§¯åˆ†å˜åŠ¨</label>
                <input type="number" id="pointsChange" name="points_change" required placeholder="æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘">
            </div>
            <div class="form-group">
                <label for="reason">å˜åŠ¨åŸå› </label>
                <input type="text" id="reason" name="reason" required placeholder="ç§¯åˆ†å˜åŠ¨åŸå› " maxlength="100">
            </div>
            <button type="submit" class="btn">æäº¤ç§¯åˆ†å˜åŠ¨</button>
        </form>
        <div id="pointsChangeResult" style="margin-top: 15px;"></div>
    </div>
    
    <div class="card">
        <h3>åˆ›å»ºå…‘æ¢è®°å½•</h3>
        <form id="exchangeForm">
            <div class="form-group">
                <label for="exchangeCoupleId">æƒ…ä¾£ID</label>
                <input type="text" id="exchangeCoupleId" name="couple_id" required placeholder="è¾“å…¥æƒ…ä¾£ID">
            </div>
            <div class="form-group">
                <label for="exchangeRewardId">å¥–åŠ±ID</label>
                <input type="text" id="exchangeRewardId" name="reward_id" required placeholder="è¾“å…¥å¥–åŠ±ID">
            </div>
            <div class="form-group">
                <label for="pointsUsed">ä½¿ç”¨ç§¯åˆ†</label>
                <input type="number" id="pointsUsed" name="points_used" required placeholder="ä½¿ç”¨çš„ç§¯åˆ†" min="1">
            </div>
            <button type="submit" class="btn">åˆ›å»ºå…‘æ¢è®°å½•</button>
        </form>
        <div id="exchangeResult" style="margin-top: 15px;"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // æ·»åŠ å¥–åŠ±è¡¨å•æäº¤
        document.getElementById('addRewardForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const rewardData = {
                reward_id: formData.get('reward_id'),
                name: formData.get('name'),
                points_needed: parseInt(formData.get('points_needed')),
                stock: parseInt(formData.get('stock')),
                description: formData.get('description')
            };
            
            try {
                const response = await fetch('/api/rewards/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(rewardData)
                });
                
                const result = await response.json();
                const addRewardResult = document.getElementById('addRewardResult');
                
                if (response.ok) {
                    addRewardResult.innerHTML = `<div style="color: green;">âœ… ${result.message}</div>`;
                    e.target.reset();
                } else {
                    addRewardResult.innerHTML = `<div style="color: red;">âŒ ${result.detail || result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('addRewardResult').innerHTML = `<div style="color: red;">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
            }
        });
        
        // ç§¯åˆ†å˜åŠ¨è¡¨å•æäº¤
        document.getElementById('pointsChangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const pointsData = {
                couple_id: formData.get('couple_id'),
                points_change: parseInt(formData.get('points_change')),
                reason: formData.get('reason')
            };
            
            try {
                const response = await fetch('/api/points/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(pointsData)
                });
                
                const result = await response.json();
                const pointsChangeResult = document.getElementById('pointsChangeResult');
                
                if (response.ok) {
                    pointsChangeResult.innerHTML = `<div style="color: green;">âœ… ${result.message}ï¼Œæ–°ç§¯åˆ†: ${result.new_points}</div>`;
                    e.target.reset();
                } else {
                    pointsChangeResult.innerHTML = `<div style="color: red;">âŒ ${result.detail || result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('pointsChangeResult').innerHTML = `<div style="color: red;">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
            }
        });
        
        // å…‘æ¢è®°å½•è¡¨å•æäº¤
        document.getElementById('exchangeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const exchangeData = {
                couple_id: formData.get('couple_id'),
                reward_id: formData.get('reward_id'),
                points_used: parseInt(formData.get('points_used'))
            };
            
            try {
                const response = await fetch('/api/exchanges/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(exchangeData)
                });
                
                const result = await response.json();
                const exchangeResult = document.getElementById('exchangeResult');
                
                if (response.ok) {
                    exchangeResult.innerHTML = `<div style="color: green;">âœ… ${result.message}</div>`;
                    e.target.reset();
                } else {
                    exchangeResult.innerHTML = `<div style="color: red;">âŒ ${result.detail || result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('exchangeResult').innerHTML = `<div style="color: red;">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
            }
        });
    </script>
{% endblock %}
