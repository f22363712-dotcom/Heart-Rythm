{% extends 'base.html' %}

{% block title %}å¥–åŠ±å…‘æ¢{% endblock %}

{% block content %}
<div class="page-title">
    <span>ğŸ</span> å¥–åŠ±å…‘æ¢
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 24px;">
    <!-- æ·»åŠ å¥–åŠ± -->
    <div class="card">
        <h3>âœ¨ æ·»åŠ æ–°å¥–åŠ±</h3>
        <form id="addRewardForm">
            <div class="form-group">
                <label for="rewardId">å¥–åŠ±ID</label>
                <input type="text" id="rewardId" name="reward_id" required placeholder="ä¾‹å¦‚ï¼šreward001">
            </div>
            <div class="form-group">
                <label for="rewardName">å¥–åŠ±åç§°</label>
                <input type="text" id="rewardName" name="name" required placeholder="ä¾‹å¦‚ï¼šæµªæ¼«æ™šé¤">
            </div>
            <div class="form-group">
                <label for="pointsNeeded">æ‰€éœ€ç§¯åˆ†</label>
                <input type="number" id="pointsNeeded" name="points_needed" required placeholder="å…‘æ¢æ‰€éœ€ç§¯åˆ†" min="1">
            </div>
            <div class="form-group">
                <label for="stock">åº“å­˜æ•°é‡</label>
                <input type="number" id="stock" name="stock" required placeholder="å¥–åŠ±åº“å­˜" min="0">
            </div>
            <div class="form-group">
                <label for="description">å¥–åŠ±æè¿°</label>
                <textarea id="description" name="description" placeholder="æè¿°è¿™ä¸ªå¥–åŠ±..." rows="3" style="resize: vertical;"></textarea>
            </div>
            <button type="submit" class="btn" style="width: 100%;">ğŸ æ·»åŠ å¥–åŠ±</button>
        </form>
        <div id="addRewardResult"></div>
    </div>

    <!-- ç§¯åˆ†å˜åŠ¨ -->
    <div class="card">
        <h3>â­ ç§¯åˆ†å˜åŠ¨</h3>
        <form id="pointsChangeForm">
            <div class="form-group">
                <label for="changeCoupleId">æƒ…ä¾£ID</label>
                <input type="text" id="changeCoupleId" name="couple_id" required placeholder="è¾“å…¥æƒ…ä¾£ID">
            </div>
            <div class="form-group">
                <label for="pointsChange">ç§¯åˆ†å˜åŠ¨</label>
                <input type="number" id="pointsChange" name="points_change" required placeholder="æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘">
            </div>
            <div class="form-group">
                <label for="reason">å˜åŠ¨åŸå› </label>
                <input type="text" id="reason" name="reason" required placeholder="ä¾‹å¦‚ï¼šå®Œæˆæ¯æ—¥ä»»åŠ¡" maxlength="100">
            </div>
            <button type="submit" class="btn btn-secondary" style="width: 100%;">ğŸ“ æäº¤å˜åŠ¨</button>
        </form>
        <div id="pointsChangeResult"></div>
    </div>

    <!-- åˆ›å»ºå…‘æ¢è®°å½• -->
    <div class="card">
        <h3>ğŸ”„ åˆ›å»ºå…‘æ¢è®°å½•</h3>
        <form id="exchangeForm">
            <div class="form-group">
                <label for="exchangeCoupleId">æƒ…ä¾£ID</label>
                <input type="text" id="exchangeCoupleId" name="couple_id" required placeholder="è¾“å…¥æƒ…ä¾£ID">
            </div>
            <div class="form-group">
                <label for="exchangeRewardId">å¥–åŠ±ID</label>
                <input type="text" id="exchangeRewardId" name="reward_id" required placeholder="è¾“å…¥å¥–åŠ±ID">
            </div>
            <div class="form-group">
                <label for="pointsUsed">ä½¿ç”¨ç§¯åˆ†</label>
                <input type="number" id="pointsUsed" name="points_used" required placeholder="ä½¿ç”¨çš„ç§¯åˆ†" min="1">
            </div>
            <button type="submit" class="btn" style="width: 100%; background: linear-gradient(135deg, #059669, #10b981);">ğŸ’ ç¡®è®¤å…‘æ¢</button>
        </form>
        <div id="exchangeResult"></div>
    </div>
</div>

<!-- å¥–åŠ±å•†åŸ -->
<div class="card" style="margin-top: 24px;">
    <h3>ğŸª å¥–åŠ±å•†åŸ</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;" id="rewardsList">
        {% if rewards %}
            {% for reward in rewards %}
            <div style="background: linear-gradient(145deg, white, #fff5f7); border-radius: 20px; padding: 24px; border: 1px solid rgba(232, 74, 127, 0.1); transition: all 0.3s ease;">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 16px;">
                    <div>
                        <h4 style="font-size: 1.2rem; color: var(--text-dark); margin-bottom: 4px;">
                            ğŸ {{ reward.name }}
                        </h4>
                        <p style="font-size: 0.85rem; color: var(--text-light);">ID: {{ reward.reward_id }}</p>
                    </div>
                    <div style="background: var(--gradient-primary); color: white; padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9rem;">
                        {{ reward.points_needed }} ç§¯åˆ†
                    </div>
                </div>
                <p style="color: var(--text-light); font-size: 0.9rem; margin-bottom: 12px;">
                    {{ reward.description or 'æš‚æ— æè¿°' }}
                </p>
                <div style="display: flex; justify-content: space-between; align-items: center; padding-top: 12px; border-top: 1px dashed #f0e4e8;">
                    <span style="color: var(--text-light); font-size: 0.85rem;">åº“å­˜: {{ reward.stock }}</span>
                    {% if reward.stock > 0 %}
                    <span style="color: #059669; font-size: 0.85rem;">âœ“ å¯å…‘æ¢</span>
                    {% else %}
                    <span style="color: #dc3545; font-size: 0.85rem;">âœ— å·²å”®ç½„</span>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div style="grid-column: 1 / -1; text-align: center; padding: 60px; color: var(--text-light);">
                <div style="font-size: 4rem; margin-bottom: 16px;">ğŸ</div>
                <p>æš‚æ— å¥–åŠ±ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€ä¸ªå§ï¼</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ·»åŠ å¥–åŠ±è¡¨å•
    document.getElementById('addRewardForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const rewardData = {
            reward_id: formData.get('reward_id'),
            name: formData.get('name'),
            points_needed: parseInt(formData.get('points_needed')),
            stock: parseInt(formData.get('stock')),
            description: formData.get('description') || ''
        };
        
        try {
            const response = await fetch('/api/rewards/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(rewardData)
            });
            
            const result = await response.json();
            const addResult = document.getElementById('addRewardResult');
            
            if (response.ok) {
                addResult.innerHTML = `<div class="message message-success">âœ… ${result.message}</div>`;
                e.target.reset();
                setTimeout(() => location.reload(), 1000);
            } else {
                addResult.innerHTML = `<div class="message message-error">âŒ ${result.detail || result.error || 'æ·»åŠ å¤±è´¥'}</div>`;
            }
        } catch (error) {
            document.getElementById('addRewardResult').innerHTML = `<div class="message message-error">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
        }
    });

    // ç§¯åˆ†å˜åŠ¨è¡¨å•
    document.getElementById('pointsChangeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const pointsData = {
            couple_id: formData.get('couple_id'),
            points_change: parseInt(formData.get('points_change')),
            reason: formData.get('reason')
        };
        
        try {
            const response = await fetch('/api/points/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(pointsData)
            });
            
            const result = await response.json();
            const changeResult = document.getElementById('pointsChangeResult');
            
            if (response.ok) {
                changeResult.innerHTML = `
                    <div class="message message-success">
                        âœ… ${result.message}ï¼Œå½“å‰ç§¯åˆ†: <strong>${result.new_points}</strong>
                    </div>
                `;
                e.target.reset();
            } else {
                changeResult.innerHTML = `<div class="message message-error">âŒ ${result.detail || result.error || 'æ“ä½œå¤±è´¥'}</div>`;
            }
        } catch (error) {
            document.getElementById('pointsChangeResult').innerHTML = `<div class="message message-error">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
        }
    });

    // å…‘æ¢è®°å½•è¡¨å•
    document.getElementById('exchangeForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const exchangeData = {
            couple_id: formData.get('couple_id'),
            reward_id: formData.get('reward_id'),
            points_used: parseInt(formData.get('points_used'))
        };
        
        try {
            const response = await fetch('/api/exchanges/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(exchangeData)
            });
            
            const result = await response.json();
            const exchangeResult = document.getElementById('exchangeResult');
            
            if (response.ok) {
                exchangeResult.innerHTML = `<div class="message message-success">âœ… ${result.message}</div>`;
                e.target.reset();
            } else {
                exchangeResult.innerHTML = `<div class="message message-error">âŒ ${result.detail || result.error || 'å…‘æ¢å¤±è´¥'}</div>`;
            }
        } catch (error) {
            document.getElementById('exchangeResult').innerHTML = `<div class="message message-error">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
        }
    });
</script>
{% endblock %}
