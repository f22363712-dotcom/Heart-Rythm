{% extends "base_new.html" %}

{% block title %}é¦–é¡µ - å¿ƒåŠ¨ç§¯åˆ†ç³»ç»Ÿ{% endblock %}

{% block content %}
<style>
    /* é¦–é¡µä¸“å±æ ·å¼ */
    .welcome-section {
        text-align: center;
        margin-bottom: 48px;
        animation: fadeInDown 0.8s ease;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .welcome-section h1 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: 2.8rem;
        background: linear-gradient(135deg, var(--rose-blush), var(--rose-mauve));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 12px;
    }

    .welcome-section .tagline {
        font-size: 1.1rem;
        color: #8a7b95;
        font-weight: 400;
        letter-spacing: 1px;
    }

    /* æƒ…ä¾£ç§¯åˆ†å¡ç‰‡ - ä¸»è§†è§‰ç„¦ç‚¹ */
    .love-score-card {
        background: linear-gradient(135deg, var(--rose-blush) 0%, var(--rose-mauve) 100%);
        border-radius: 32px;
        padding: 48px 40px;
        text-align: center;
        color: white;
        box-shadow: 0 12px 48px rgba(212, 122, 158, 0.25);
        position: relative;
        overflow: hidden;
        margin-bottom: 40px;
        animation: cardRise 0.8s ease 0.2s both;
    }

    @keyframes cardRise {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .love-score-card::before {
        content: 'ğŸ’•';
        position: absolute;
        font-size: 180px;
        opacity: 0.08;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: heartbeat 2s ease-in-out infinite;
    }

    @keyframes heartbeat {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.05); }
    }

    .love-score-card .couple-names {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 24px;
        opacity: 0.95;
        position: relative;
        z-index: 1;
    }

    .love-score-card .score-display {
        font-size: 4.5rem;
        font-weight: 700;
        margin-bottom: 8px;
        position: relative;
        z-index: 1;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .love-score-card .score-label {
        font-size: 1rem;
        opacity: 0.9;
        position: relative;
        z-index: 1;
    }

    /* å¿«é€Ÿæ“ä½œå¡ç‰‡ - å¼±åŒ–ä½†å¯ç”¨ */
    .quick-action-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 32px 28px;
        text-align: center;
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.7);
        height: 100%;
        animation: cardRise 0.8s ease 0.4s both;
    }

    .quick-action-card:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 32px rgba(212, 122, 158, 0.12);
    }

    .quick-action-card .icon {
        font-size: 3rem;
        margin-bottom: 16px;
        display: block;
    }

    .quick-action-card h5 {
        font-size: 1.1rem;
        font-weight: 600;
        color: #4a3f55;
        margin-bottom: 12px;
    }

    .quick-action-card p {
        font-size: 0.9rem;
        color: #8a7b95;
        margin-bottom: 20px;
    }

    /* è®¿å®¢è§†å›¾ - ç®€æ´é‚€è¯· */
    .guest-invite {
        text-align: center;
        padding: 80px 20px;
        animation: fadeIn 0.8s ease;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .guest-invite .heart-icon {
        font-size: 80px;
        display: block;
        margin-bottom: 24px;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
    }

    .guest-invite h2 {
        font-family: 'Ma Shan Zheng', cursive;
        font-size: 2.2rem;
        color: #4a3f55;
        margin-bottom: 16px;
    }

    .guest-invite .subtitle {
        font-size: 1.1rem;
        color: #8a7b95;
        margin-bottom: 40px;
        font-style: italic;
    }

    .guest-invite .cta-buttons {
        display: flex;
        gap: 16px;
        justify-content: center;
        flex-wrap: wrap;
    }

    /* ç®¡ç†å‘˜è§†å›¾ */
    .admin-stats-card {
        background: var(--card-bg);
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 32px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.7);
        animation: cardRise 0.8s ease 0.3s both;
    }

    .admin-stats-card .stat-icon {
        font-size: 3rem;
        margin-bottom: 16px;
        display: block;
    }

    .admin-stats-card .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: var(--rose-mauve);
        margin-bottom: 8px;
    }

    .admin-stats-card .stat-label {
        font-size: 0.95rem;
        color: #8a7b95;
    }
</style>

<!-- æœªç™»å½•çŠ¶æ€ - ç®€æ´é‚€è¯· -->
<div id="guestView">
    <div class="guest-invite">
        <span class="heart-icon">ğŸ’•</span>
        <h2>å¿ƒåŠ¨ç§¯åˆ†</h2>
        <p class="subtitle">"è®©æ¯ä¸ªå°ç¾å¥½éƒ½æœ‰å›å“"</p>
        <div class="cta-buttons">
            <a href="/login" class="btn btn-primary btn-lg">
                <i class="bi bi-box-arrow-in-right"></i> å›åˆ°ä½ ä»¬çš„å°å±‹
            </a>
            <a href="/login" class="btn btn-outline-primary btn-lg">
                <i class="bi bi-heart-fill"></i> åˆ›å»ºå¿ƒåŠ¨å°å±‹
            </a>
        </div>
    </div>
</div>

<!-- å·²ç™»å½•çŠ¶æ€ - æ™®é€šç”¨æˆ· -->
<div id="userView" style="display: none;">
    <!-- æ¬¢è¿åŒºåŸŸ -->
    <div class="welcome-section">
        <h1>
            <i class="bi bi-heart-fill"></i>
            <span id="welcomeNames"></span>
        </h1>
        <p class="tagline">ä½ ä»¬çš„çˆ±çš„å°è®°æœ¬</p>
    </div>

    <!-- ç§¯åˆ†å±•ç¤ºå¡ç‰‡ -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="love-score-card">
                <div class="couple-names">
                    <span id="coupleNames"></span>
                </div>
                <div class="score-display">
                    <span id="currentPoints">0</span>
                </div>
                <div class="score-label">ä¸ªçˆ±çš„å°è®°</div>
            </div>
        </div>
    </div>

    <!-- å¿«é€Ÿæ“ä½œ -->
    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="quick-action-card">
                <span class="icon">âœ¨</span>
                <h5>è®°å½•ç¾å¥½</h5>
                <p>ç›–ä¸Šæ–°çš„çˆ±çš„å°è®°</p>
                <button class="btn btn-primary" onclick="showAddPointsModal()">
                    <i class="bi bi-plus-circle"></i> è®°å½•è¿™ä¸€åˆ»
                </button>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="quick-action-card">
                <span class="icon">ğŸ</span>
                <h5>ç”œèœœå…‘æ¢</h5>
                <p>ç”¨å°è®°å¼€å¯æƒŠå–œ</p>
                <a href="/rewards" class="btn btn-success">
                    <i class="bi bi-gift-fill"></i> å»å…‘æ¢
                </a>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="quick-action-card">
                <span class="icon">ğŸ“–</span>
                <h5>ç¾å¥½æ—¶å…‰</h5>
                <p>å›é¡¾ä½ ä»¬çš„è¶³è¿¹</p>
                <a href="/dashboard" class="btn btn-info">
                    <i class="bi bi-clock-history"></i> æŸ¥çœ‹è®°å½•
                </a>
            </div>
        </div>
    </div>
</div>

<!-- å·²ç™»å½•çŠ¶æ€ - ç®¡ç†å‘˜ -->
<div id="adminView" style="display: none;">
    <div class="welcome-section">
        <h1>
            <i class="bi bi-shield-fill-check"></i>
            ç®¡ç†åå°
        </h1>
        <p class="tagline">ç³»ç»Ÿæ¦‚è§ˆ</p>
    </div>

    <div class="row">
        <div class="col-md-4 mb-4">
            <div class="admin-stats-card">
                <span class="stat-icon">ğŸ‘¥</span>
                <div class="stat-value" id="totalCouples">0</div>
                <div class="stat-label">æƒ…ä¾£æ€»æ•°</div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="admin-stats-card">
                <span class="stat-icon">ğŸ’</span>
                <div class="stat-value" id="totalPoints">0</div>
                <div class="stat-label">æ€»å°è®°æ•°</div>
            </div>
        </div>

        <div class="col-md-4 mb-4">
            <div class="admin-stats-card">
                <span class="stat-icon">ğŸ‰</span>
                <div class="stat-value" id="totalExchanges">0</div>
                <div class="stat-label">å…‘æ¢æ¬¡æ•°</div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body text-center py-5">
                    <h4 class="mb-4">ç®¡ç†åŠŸèƒ½</h4>
                    <a href="/admin" class="btn btn-primary btn-lg">
                        <i class="bi bi-gear-fill"></i> è¿›å…¥ç®¡ç†åå°
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ ç§¯åˆ†æ¨¡æ€æ¡† -->
<div class="modal fade" id="addPointsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> è®°å½•ç¾å¥½æ—¶åˆ»
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPointsForm">
                    <div class="mb-3">
                        <label for="pointsChange" class="form-label">å°è®°æ•°é‡</label>
                        <input type="number" class="form-control" id="pointsChange" required>
                        <small class="form-text text-muted">æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘</small>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">è¿™ä¸€åˆ»çš„æ•…äº‹</label>
                        <input type="text" class="form-control" id="reason" placeholder="å†™ä¸‹è®©ä½ ä»¬å¿ƒåŠ¨çš„ç¬é—´..." required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAddPoints()">
                    ğŸ’• ç›–ä¸Šå°è®°
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let addPointsModalInstance;

    document.addEventListener('DOMContentLoaded', async function() {
        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        const modalElement = document.getElementById('addPointsModal');
        if (modalElement) {
            addPointsModalInstance = new bootstrap.Modal(modalElement);
        }

        const token = getToken();
        const isAdmin = localStorage.getItem('is_admin') === 'true';

        if (!token) {
            // æœªç™»å½•ï¼Œæ˜¾ç¤ºè®¿å®¢è§†å›¾
            document.getElementById('guestView').style.display = 'block';
        } else if (isAdmin) {
            // ç®¡ç†å‘˜è§†å›¾
            document.getElementById('adminView').style.display = 'block';
            await loadAdminStats();
        } else {
            // æ™®é€šç”¨æˆ·è§†å›¾
            document.getElementById('userView').style.display = 'block';
            await loadUserInfo();
        }
    });

    // åŠ è½½ç”¨æˆ·ä¿¡æ¯
    async function loadUserInfo() {
        const data = await apiRequest('/auth/me');
        if (data && data.couple) {
            const names = `${data.couple.names[0]} & ${data.couple.names[1]}`;
            document.getElementById('welcomeNames').textContent = names + ' çš„å°å±‹';
            document.getElementById('coupleNames').textContent = names;
            document.getElementById('currentPoints').textContent = data.couple.points;
        }
    }

    // åŠ è½½ç®¡ç†å‘˜ç»Ÿè®¡
    async function loadAdminStats() {
        const data = await apiRequest('/admin/stats');
        if (data) {
            document.getElementById('totalCouples').textContent = data.total_couples;
            document.getElementById('totalPoints').textContent = data.total_points;
            document.getElementById('totalExchanges').textContent = data.total_exchanges;
        }
    }

    // æ˜¾ç¤ºæ·»åŠ ç§¯åˆ†æ¨¡æ€æ¡†
    function showAddPointsModal() {
        if (addPointsModalInstance) {
            addPointsModalInstance.show();
        }
    }

    // æäº¤æ·»åŠ ç§¯åˆ†
    async function submitAddPoints() {
        const pointsChange = parseInt(document.getElementById('pointsChange').value);
        const reason = document.getElementById('reason').value;

        if (!pointsChange || !reason) {
            showAlert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
            return;
        }

        const data = await apiRequest('/points', {
            method: 'POST',
            body: JSON.stringify({
                points_change: pointsChange,
                reason: reason
            })
        });

        if (data) {
            showAlert('âœ¨ åˆä¸€ä¸ªç¾å¥½è¢«è®°å½•å•¦ï¼', 'success');
            addPointsModalInstance.hide();
            document.getElementById('addPointsForm').reset();
            await loadUserInfo();
        }
    }
</script>
{% endblock %}
