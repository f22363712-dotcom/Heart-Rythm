{% extends "base_new.html" %}

{% block title %}ä»ªè¡¨æ¿ - å¿ƒåŠ¨ç§¯åˆ†ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    /* Dashboardä¸“å±æ ·å¼ */
    .dashboard-header {
        text-align: center;
        margin-bottom: 40px;
        animation: fadeInDown 0.6s ease;
    }
    
    .dashboard-header h2 {
        font-size: 2.5rem;
        background: linear-gradient(135deg, #ff6b8a 0%, #e84a7f 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
    }
    
    /* æƒ…ä¾£å¡ç‰‡ç‰¹æ®Šæ ·å¼ */
    .couple-card {
        position: relative;
        overflow: hidden;
    }
    
    .couple-card::before {
        content: 'ğŸ’•';
        position: absolute;
        font-size: 120px;
        opacity: 0.08;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        animation: heartbeat 2s ease-in-out infinite;
    }
    
    @keyframes heartbeat {
        0%, 100% { transform: translate(-50%, -50%) scale(1); }
        50% { transform: translate(-50%, -50%) scale(1.1); }
    }
    
    /* ç§¯åˆ†æ•°å­—åŠ¨ç”» */
    .score-display {
        font-size: 3.5rem;
        font-weight: 700;
        background: linear-gradient(135deg, #ff6b8a 0%, #e84a7f 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        animation: pulse 2s ease-in-out infinite;
    }
    
    @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.8; }
    }
    
    /* ç»Ÿè®¡å¡ç‰‡å›¾æ ‡ */
    .stat-icon {
        font-size: 3.5rem;
        margin-bottom: 16px;
        display: inline-block;
        animation: float 3s ease-in-out infinite;
    }
    
    @keyframes float {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
    }
    
    /* å¿«é€Ÿæ“ä½œæŒ‰é’®ç»„ */
    .quick-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: center;
    }
    
    .quick-actions .btn {
        flex: 1;
        min-width: 150px;
        padding: 14px 24px;
        font-size: 1rem;
    }
    
    /* æ—¶é—´è½´æ ·å¼ */
    .timeline-item {
        position: relative;
        padding-left: 40px;
        margin-bottom: 20px;
        animation: slideInLeft 0.5s ease;
    }
    
    .timeline-item::before {
        content: '';
        position: absolute;
        left: 12px;
        top: 0;
        bottom: -20px;
        width: 2px;
        background: linear-gradient(180deg, #ff6b8a 0%, transparent 100%);
    }
    
    .timeline-item::after {
        content: '';
        position: absolute;
        left: 6px;
        top: 8px;
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background: #ff6b8a;
        box-shadow: 0 0 0 4px rgba(255, 107, 138, 0.2);
    }
    
    .timeline-item:last-child::before {
        display: none;
    }
    
    @keyframes slideInLeft {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-header">
    <h2>
        <i class="bi bi-speedometer2"></i> æˆ‘çš„ä»ªè¡¨æ¿
    </h2>
    <p class="text-muted">è®°å½•çˆ±çš„æ¯ä¸€åˆ» Â· è§è¯å¿ƒåŠ¨çš„ç¬é—´</p>
</div>

<!-- ç§¯åˆ†æ¦‚è§ˆ - Bento Gridå¸ƒå±€ -->
<div class="row mb-4 g-3">
    <div class="col-md-4">
        <div class="card text-center couple-card" style="min-height: 220px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="stat-icon">ğŸ’‘</div>
                <h5 class="card-title text-muted mb-3">æƒ…ä¾£ä¿¡æ¯</h5>
                <h3 id="coupleNames" style="font-weight: 600; color: #e84a7f;">åŠ è½½ä¸­...</h3>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center" style="min-height: 220px; background: linear-gradient(135deg, rgba(255,107,138,0.1) 0%, rgba(232,74,127,0.05) 100%);">
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="stat-icon">âœ¨</div>
                <h5 class="card-title text-muted mb-3">å½“å‰ç§¯åˆ†</h5>
                <div class="score-display" id="currentPoints">0</div>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card text-center" style="min-height: 220px;">
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="stat-icon">ğŸ“Š</div>
                <h5 class="card-title text-muted mb-3">å†å²è®°å½•</h5>
                <h2 class="display-4" style="color: #20c997; font-weight: 700;" id="historyCount">0</h2>
                <small class="text-muted">æ¡è®°å½•</small>
            </div>
        </div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card" style="background: linear-gradient(135deg, rgba(255,255,255,0.9) 0%, rgba(255,249,245,0.8) 100%);">
            <div class="card-body text-center">
                <h5 class="card-title mb-4">
                    <i class="bi bi-lightning-fill" style="color: #ffc107;"></i> å¿«é€Ÿæ“ä½œ
                </h5>
                <div class="quick-actions">
                    <button class="btn btn-primary" onclick="showAddPointsModal()">
                        <i class="bi bi-plus-circle"></i> æ·»åŠ ç§¯åˆ†
                    </button>
                    <button class="btn btn-success" onclick="window.location.href='/rewards'">
                        <i class="bi bi-gift"></i> æŸ¥çœ‹å¥–åŠ±
                    </button>
                    <button class="btn btn-info text-white" onclick="loadHistory()">
                        <i class="bi bi-arrow-clockwise"></i> åˆ·æ–°æ•°æ®
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ç§¯åˆ†å†å² - æ—¶é—´è½´æ ·å¼ -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="bi bi-clock-history"></i> ç§¯åˆ†å†å²
                </h5>
            </div>
            <div class="card-body">
                <div id="historyList">
                    <div class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">åŠ è½½ä¸­...</span>
                        </div>
                        <p class="mt-2 text-muted">åŠ è½½å†å²è®°å½•...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- æ·»åŠ ç§¯åˆ†æ¨¡æ€æ¡† -->
<div class="modal fade" id="addPointsModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-plus-circle"></i> æ·»åŠ ç§¯åˆ†
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPointsForm">
                    <div class="mb-3">
                        <label for="pointsChange" class="form-label">ç§¯åˆ†å˜åŒ–</label>
                        <input type="number" class="form-control" id="pointsChange" required>
                        <small class="form-text text-muted">æ­£æ•°å¢åŠ ï¼Œè´Ÿæ•°å‡å°‘</small>
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">åŸå› </label>
                        <input type="text" class="form-control" id="reason" required placeholder="ä¾‹å¦‚ï¼šå®Œæˆæ¯æ—¥ä»»åŠ¡">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                <button type="button" class="btn btn-primary" onclick="submitAddPoints()">
                    <i class="bi bi-check-circle"></i> ç¡®å®š
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    let addPointsModalInstance;

    document.addEventListener('DOMContentLoaded', async function() {
        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        if (!getToken()) {
            window.location.href = '/login';
            return;
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        const modalElement = document.getElementById('addPointsModal');
        if (modalElement) {
            addPointsModalInstance = new bootstrap.Modal(modalElement);
        }

        // åŠ è½½æ•°æ®
        await loadDashboardData();
    });

    // åŠ è½½ä»ªè¡¨æ¿æ•°æ®
    async function loadDashboardData() {
        await Promise.all([
            loadCoupleInfo(),
            loadHistory()
        ]);
    }

    // åŠ è½½æƒ…ä¾£ä¿¡æ¯
    async function loadCoupleInfo() {
        const data = await apiRequest('/couples/me');
        if (data) {
            document.getElementById('coupleNames').textContent =
                `${data.names[0]} & ${data.names[1]}`;
            document.getElementById('currentPoints').textContent = data.points;
        }
    }

    // åŠ è½½ç§¯åˆ†å†å²
    async function loadHistory() {
        const data = await apiRequest('/points/history?limit=50');
        if (data && data.history) {
            displayHistory(data.history);
            document.getElementById('historyCount').textContent = data.history.length;
        }
    }

    // æ˜¾ç¤ºå†å²è®°å½•
    function displayHistory(history) {
        const listElement = document.getElementById('historyList');

        if (history.length === 0) {
            listElement.innerHTML = `
                <div class="text-center py-5 text-muted">
                    <i class="bi bi-inbox display-1"></i>
                    <p class="mt-3">æš‚æ— ç§¯åˆ†è®°å½•</p>
                    <button class="btn btn-primary" onclick="showAddPointsModal()">
                        <i class="bi bi-plus-circle"></i> æ·»åŠ ç¬¬ä¸€æ¡è®°å½•
                    </button>
                </div>
            `;
            return;
        }

        let html = '<div class="list-group">';
        history.forEach(record => {
            const isPositive = record.points_change > 0;
            const badgeClass = isPositive ? 'bg-success' : 'bg-danger';
            const icon = isPositive ? 'arrow-up-circle' : 'arrow-down-circle';
            const sign = isPositive ? '+' : '';

            const date = new Date(record.created_time);
            const dateStr = date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });

            html += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">
                                <i class="bi bi-${icon} text-${isPositive ? 'success' : 'danger'}"></i>
                                ${record.reason || 'æ— åŸå› '}
                            </h6>
                            <small class="text-muted">
                                <i class="bi bi-clock"></i> ${dateStr}
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge ${badgeClass} fs-5">
                                ${sign}${record.points_change}
                            </span>
                        </div>
                    </div>
                </div>
            `;
        });
        html += '</div>';

        listElement.innerHTML = html;
    }

    // æ˜¾ç¤ºæ·»åŠ ç§¯åˆ†æ¨¡æ€æ¡†
    function showAddPointsModal() {
        if (addPointsModalInstance) {
            document.getElementById('addPointsForm').reset();
            addPointsModalInstance.show();
        }
    }

    // æäº¤æ·»åŠ ç§¯åˆ†
    async function submitAddPoints() {
        const pointsChange = parseInt(document.getElementById('pointsChange').value);
        const reason = document.getElementById('reason').value.trim();

        if (!pointsChange || !reason) {
            showAlert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯', 'warning');
            return;
        }

        if (pointsChange === 0) {
            showAlert('ç§¯åˆ†å˜åŒ–ä¸èƒ½ä¸º0', 'warning');
            return;
        }

        const data = await apiRequest('/points', {
            method: 'POST',
            body: JSON.stringify({
                points_change: pointsChange,
                reason: reason
            })
        });

        if (data) {
            showAlert('ç§¯åˆ†æ›´æ–°æˆåŠŸï¼', 'success');
            addPointsModalInstance.hide();
            document.getElementById('addPointsForm').reset();

            // åˆ·æ–°æ•°æ®
            await loadDashboardData();
        }
    }
</script>

{% endblock %}
