{% extends 'base.html' %}

{% block title %}æƒ…ä¾£ç®¡ç†{% endblock %}

{% block content %}
    <h2>ğŸ§‘â€ğŸ¤â€ğŸ§‘ æƒ…ä¾£ç®¡ç†</h2>
    
    <div class="card">
        <h3>æ·»åŠ æ–°æƒ…ä¾£</h3>
        <form id="addCoupleForm">
            <div class="form-group">
                <label for="coupleId">æƒ…ä¾£ID</label>
                <input type="text" id="coupleId" name="couple_id" required placeholder="ä¾‹å¦‚ï¼š001">
            </div>
            <div class="form-group">
                <label for="name1">å§“å1</label>
                <input type="text" id="name1" name="name1" required placeholder="ç¬¬ä¸€ä¸ªæƒ…ä¾£çš„åå­—">
            </div>
            <div class="form-group">
                <label for="name2">å§“å2</label>
                <input type="text" id="name2" name="name2" required placeholder="ç¬¬äºŒä¸ªæƒ…ä¾£çš„åå­—">
            </div>
            <button type="submit" class="btn">æ·»åŠ æƒ…ä¾£</button>
        </form>
        <div id="addResult" style="margin-top: 15px;"></div>
    </div>
    
    <div class="card">
        <h3>æŸ¥è¯¢æƒ…ä¾£ä¿¡æ¯</h3>
        <div style="display: flex; gap: 10px; margin-bottom: 20px;">
            <div class="form-group" style="flex: 1;">
                <input type="text" id="queryCoupleId" placeholder="è¾“å…¥æƒ…ä¾£IDæŸ¥è¯¢" style="margin: 0;">
            </div>
            <button id="queryCoupleBtn" class="btn btn-secondary">æŸ¥è¯¢</button>
        </div>
        <div id="coupleInfo"></div>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        // æ·»åŠ æƒ…ä¾£è¡¨å•æäº¤
        document.getElementById('addCoupleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const coupleData = {
                couple_id: formData.get('couple_id'),
                name1: formData.get('name1'),
                name2: formData.get('name2')
            };
            
            try {
                const response = await fetch('/api/couples/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(coupleData)
                });
                
                const result = await response.json();
                const addResult = document.getElementById('addResult');
                
                if (response.ok) {
                    addResult.innerHTML = `<div style="color: green;">âœ… ${result.message}</div>`;
                    e.target.reset();
                } else {
                    addResult.innerHTML = `<div style="color: red;">âŒ ${result.detail || result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('addResult').innerHTML = `<div style="color: red;">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
            }
        });
        
        // æŸ¥è¯¢æƒ…ä¾£ä¿¡æ¯
        document.getElementById('queryCoupleBtn').addEventListener('click', async () => {
            const coupleId = document.getElementById('queryCoupleId').value.trim();
            if (!coupleId) {
                alert('è¯·è¾“å…¥æƒ…ä¾£ID');
                return;
            }
            
            try {
                const response = await fetch(`/api/couples/${coupleId}/`);
                const result = await response.json();
                const coupleInfo = document.getElementById('coupleInfo');
                
                if (response.ok) {
                    coupleInfo.innerHTML = `
                        <div class="card">
                            <h4>æƒ…ä¾£ä¿¡æ¯</h4>
                            <p><strong>æƒ…ä¾£ID:</strong> ${result.couple_id}</p>
                            <p><strong>å§“å:</strong> ${result.names[0]} å’Œ ${result.names[1]}</p>
                            <p><strong>ç§¯åˆ†:</strong> ${result.points}</p>
                            <p><strong>åˆ›å»ºæ—¶é—´:</strong> ${new Date(result.created_time).toLocaleString()}</p>
                            <h5>ç§¯åˆ†å˜åŠ¨å†å²:</h5>
                            <ul style="margin-left: 20px;">
                                ${result.history.map(history => `
                                    <li>
                                        ${new Date(history.timestamp).toLocaleString()}: 
                                        ${history.points_change > 0 ? '+' : ''}${history.points_change} ç§¯åˆ†
                                        (${history.reason})
                                        <br>æ–°ä½™é¢: ${history.new_balance}
                                    </li>
                                `).join('')}
                            </ul>
                        </div>
                    `;
                } else {
                    coupleInfo.innerHTML = `<div style="color: red;">âŒ ${result.detail || result.message}</div>`;
                }
            } catch (error) {
                document.getElementById('coupleInfo').innerHTML = `<div style="color: red;">âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}</div>`;
            }
        });
    </script>
{% endblock %}
