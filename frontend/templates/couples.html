{% extends 'base.html' %}

{% block title %}æƒ…ä¾£ç®¡ç†{% endblock %}

{% block content %}
<div class="page-title">
    <span>ğŸ’‘</span> æƒ…ä¾£ç®¡ç†
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
    <!-- æ·»åŠ æƒ…ä¾£è¡¨å• -->
    <div class="card">
        <h3>ğŸ’• æ·»åŠ æ–°æƒ…ä¾£</h3>
        <form id="addCoupleForm">
            <div class="form-group">
                <label for="coupleId">æƒ…ä¾£ID</label>
                <input type="text" id="coupleId" name="couple_id" required placeholder="ä¾‹å¦‚ï¼šcouple001">
            </div>
            <div class="form-group">
                <label for="name1">ğŸ’â€â™‚ï¸ å§“åä¸€</label>
                <input type="text" id="name1" name="name1" required placeholder="ç¬¬ä¸€ä¸ªäººçš„åå­—">
            </div>
            <div class="form-group">
                <label for="name2">ğŸ’â€â™€ï¸ å§“åäºŒ</label>
                <input type="text" id="name2" name="name2" required placeholder="ç¬¬äºŒä¸ªäººçš„åå­—">
            </div>
            <button type="submit" class="btn" style="width: 100%;">
                ğŸ’— æ·»åŠ æƒ…ä¾£
            </button>
        </form>
        <div id="addResult"></div>
    </div>

    <!-- æŸ¥è¯¢æƒ…ä¾£ä¿¡æ¯ -->
    <div class="card">
        <h3>ğŸ” æŸ¥è¯¢æƒ…ä¾£ä¿¡æ¯</h3>
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <input type="text" id="queryCoupleId" placeholder="è¾“å…¥æƒ…ä¾£IDæŸ¥è¯¢" style="flex: 1; padding: 14px 18px; border: 2px solid #f0e4e8; border-radius: 12px; font-size: 1rem;">
            <button id="queryCoupleBtn" class="btn btn-secondary">æŸ¥è¯¢</button>
        </div>
        <div id="coupleInfo"></div>
    </div>
</div>

<!-- æƒ…ä¾£åˆ—è¡¨ -->
<div class="card" style="margin-top: 24px;">
    <h3>ğŸ“‹ æƒ…ä¾£åˆ—è¡¨</h3>
    <div class="data-list" id="couplesList">
        {% if couples %}
            {% for couple in couples %}
            <div class="data-item">
                <div class="info">
                    <h4>{{ couple.names[0] }} ğŸ’• {{ couple.names[1] }}</h4>
                    <p>ID: {{ couple.couple_id }}</p>
                </div>
                <div class="points">{{ couple.points }} ç§¯åˆ†</div>
            </div>
            {% endfor %}
        {% else %}
            <div style="text-align: center; padding: 40px; color: var(--text-light);">
                <div style="font-size: 3rem; margin-bottom: 16px;">ğŸ’”</div>
                <p>æš‚æ— æƒ…ä¾£æ•°æ®ï¼Œå¿«æ¥æ·»åŠ ç¬¬ä¸€å¯¹å§ï¼</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ·»åŠ æƒ…ä¾£è¡¨å•æäº¤
    document.getElementById('addCoupleForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const coupleData = {
            couple_id: formData.get('couple_id'),
            name1: formData.get('name1'),
            name2: formData.get('name2')
        };
        
        try {
            const response = await fetch('/api/couples/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(coupleData)
            });
            
            const result = await response.json();
            const addResult = document.getElementById('addResult');
            
            if (response.ok) {
                addResult.innerHTML = `
                    <div class="message message-success">
                        âœ… ${result.message}
                    </div>
                `;
                e.target.reset();
                // åˆ·æ–°é¡µé¢æ˜¾ç¤ºæ–°æ•°æ®
                setTimeout(() => location.reload(), 1000);
            } else {
                addResult.innerHTML = `
                    <div class="message message-error">
                        âŒ ${result.detail || result.error || 'æ·»åŠ å¤±è´¥'}
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('addResult').innerHTML = `
                <div class="message message-error">
                    âŒ æœåŠ¡å™¨é”™è¯¯: ${error.message}
                </div>
            `;
        }
    });
    
    // æŸ¥è¯¢æƒ…ä¾£ä¿¡æ¯
    document.getElementById('queryCoupleBtn').addEventListener('click', async () => {
        const coupleId = document.getElementById('queryCoupleId').value.trim();
        if (!coupleId) {
            alert('è¯·è¾“å…¥æƒ…ä¾£ID');
            return;
        }
        
        try {
            const response = await fetch(`/api/couples/${coupleId}/`);
            const result = await response.json();
            const coupleInfo = document.getElementById('coupleInfo');
            
            if (response.ok) {
                let historyHtml = '';
                if (result.history && result.history.length > 0) {
                    historyHtml = result.history.slice(-5).reverse().map(h => `
                        <div class="history-item">
                            <div class="time">${new Date(h.timestamp).toLocaleString('zh-CN')}</div>
                            <div>
                                <span class="change ${h.points_change >= 0 ? 'positive' : 'negative'}">
                                    ${h.points_change >= 0 ? '+' : ''}${h.points_change} ç§¯åˆ†
                                </span>
                                - ${h.reason}
                            </div>
                        </div>
                    `).join('');
                } else {
                    historyHtml = '<p style="color: var(--text-light); text-align: center;">æš‚æ— ç§¯åˆ†å˜åŠ¨è®°å½•</p>';
                }
                
                coupleInfo.innerHTML = `
                    <div style="background: linear-gradient(135deg, #fff0f5, #ffe4ec); border-radius: 16px; padding: 24px; margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <div>
                                <h4 style="font-size: 1.3rem; color: var(--text-dark); margin-bottom: 8px;">
                                    ${result.names[0]} ğŸ’• ${result.names[1]}
                                </h4>
                                <p style="color: var(--text-light); font-size: 0.9rem;">ID: ${result.couple_id}</p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 2rem; font-weight: 700; color: var(--primary-rose);">
                                    ${result.points}
                                </div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">å½“å‰ç§¯åˆ†</div>
                            </div>
                        </div>
                        <h5 style="color: var(--text-dark); margin-bottom: 12px;">ğŸ“œ æœ€è¿‘è®°å½•</h5>
                        ${historyHtml}
                    </div>
                `;
            } else {
                coupleInfo.innerHTML = `
                    <div class="message message-error">
                        âŒ ${result.detail || 'æœªæ‰¾åˆ°è¯¥æƒ…ä¾£'}
                    </div>
                `;
            }
        } catch (error) {
            document.getElementById('coupleInfo').innerHTML = `
                <div class="message message-error">
                    âŒ æŸ¥è¯¢å¤±è´¥: ${error.message}
                </div>
            `;
        }
    });

    // å›è½¦é”®è§¦å‘æŸ¥è¯¢
    document.getElementById('queryCoupleId').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            document.getElementById('queryCoupleBtn').click();
        }
    });
</script>
{% endblock %}
