{% extends 'base.html' %}

{% block title %}æ•°æ®ç»Ÿè®¡{% endblock %}

{% block content %}
<div class="page-title">
    <span>ğŸ“Š</span> æ•°æ®ç»Ÿè®¡
</div>

<!-- ç³»ç»ŸçŠ¶æ€ -->
<div class="card" style="margin-bottom: 24px;">
    <h3>ğŸ”Œ ç³»ç»ŸçŠ¶æ€</h3>
    <div style="display: flex; align-items: center; gap: 12px; margin-top: 16px;">
        <div id="statusIndicator" style="width: 12px; height: 12px; border-radius: 50%; background: #ffc107;"></div>
        <span id="statusText" style="color: var(--text-light);">æ£€æŸ¥ä¸­...</span>
    </div>
</div>

<!-- ç»Ÿè®¡æ•°æ® -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="icon">ğŸ’‘</div>
        <h3>æƒ…ä¾£æ•°é‡</h3>
        <div class="value" id="stat-couples">{{ stats.total_couples if stats else '0' }}</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ</div>
        <h3>å¥–åŠ±æ•°é‡</h3>
        <div class="value" id="stat-rewards">{{ stats.total_rewards if stats else '0' }}</div>
    </div>
    <div class="stat-card">
        <div class="icon">â­</div>
        <h3>æ€»ç§¯åˆ†</h3>
        <div class="value" id="stat-points">{{ stats.total_points if stats else '0' }}</div>
    </div>
    <div class="stat-card">
        <div class="icon">ğŸ”„</div>
        <h3>å…‘æ¢æ¬¡æ•°</h3>
        <div class="value" id="stat-exchanges">{{ stats.total_exchanges if stats else '0' }}</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 24px;">
    <!-- åˆ·æ–°ç»Ÿè®¡ -->
    <div class="card">
        <h3>ğŸ”„ åˆ·æ–°æ•°æ®</h3>
        <p style="color: var(--text-light); margin-bottom: 20px;">
            ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®åˆ·æ–°ç»Ÿè®¡æ•°æ®
        </p>
        <button id="refreshStatsBtn" class="btn" style="width: 100%;">
            ğŸ“Š åˆ·æ–°ç»Ÿè®¡
        </button>
        <div id="refreshResult"></div>
        <div style="margin-top: 16px; padding: 16px; background: #f8f9fa; border-radius: 12px;">
            <p style="font-size: 0.85rem; color: var(--text-light);">
                <strong>æœ€åæ›´æ–°:</strong> 
                <span id="lastUpdate">{{ stats.last_updated if stats else 'æœªçŸ¥' }}</span>
            </p>
        </div>
    </div>

    <!-- å¤‡ä»½ç®¡ç† -->
    <div class="card">
        <h3>ğŸ’¾ å¤‡ä»½ç®¡ç†</h3>
        <p style="color: var(--text-light); margin-bottom: 20px;">
            åˆ›å»ºæ•°æ®å¤‡ä»½ï¼Œä¿éšœæ•°æ®å®‰å…¨
        </p>
        <button id="createBackupBtn" class="btn btn-secondary" style="width: 100%;">
            ğŸ’¾ åˆ›å»ºå¤‡ä»½
        </button>
        <div id="backupResult"></div>
        
        <div style="margin-top: 20px;">
            <h4 style="font-size: 1rem; color: var(--text-dark); margin-bottom: 12px;">ğŸ“ å¤‡ä»½åˆ—è¡¨</h4>
            <div id="backupsList" style="max-height: 200px; overflow-y: auto;">
                <p style="color: var(--text-light); font-size: 0.9rem;">åŠ è½½ä¸­...</p>
            </div>
        </div>
    </div>
</div>

<!-- APIä¿¡æ¯ -->
<div class="card" style="margin-top: 24px;">
    <h3>ğŸ”— APIä¿¡æ¯</h3>
    <div style="display: grid; gap: 16px; margin-top: 16px;">
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; font-family: monospace;">
            <p style="margin-bottom: 8px; color: var(--text-light); font-size: 0.85rem;">åç«¯APIåœ°å€</p>
            <code style="color: var(--primary-rose);">http://localhost:8000</code>
        </div>
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; font-family: monospace;">
            <p style="margin-bottom: 8px; color: var(--text-light); font-size: 0.85rem;">APIæ–‡æ¡£åœ°å€</p>
            <a href="http://localhost:8000/docs" target="_blank" style="color: var(--primary-rose);">
                http://localhost:8000/docs
            </a>
        </div>
        <div style="padding: 16px; background: #f8f9fa; border-radius: 12px; font-family: monospace;">
            <p style="margin-bottom: 8px; color: var(--text-light); font-size: 0.85rem;">å¥åº·æ£€æŸ¥</p>
            <a href="http://localhost:8000/health/" target="_blank" style="color: var(--primary-rose);">
                http://localhost:8000/health/
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // æ£€æŸ¥åç«¯çŠ¶æ€
    async function checkBackendStatus() {
        const indicator = document.getElementById('statusIndicator');
        const text = document.getElementById('statusText');
        
        try {
            const response = await fetch('/api/health/', { timeout: 5000 });
            if (response.ok) {
                indicator.style.background = '#28a745';
                text.textContent = 'ğŸ’š åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸';
                text.style.color = '#28a745';
            } else {
                throw new Error('Backend error');
            }
        } catch (error) {
            indicator.style.background = '#dc3545';
            text.textContent = 'ğŸ’” åç«¯æœåŠ¡æœªè¿æ¥ï¼Œè¯·å¯åŠ¨åç«¯';
            text.style.color = '#dc3545';
        }
    }

    // åˆ·æ–°ç»Ÿè®¡æ•°æ®
    document.getElementById('refreshStatsBtn').addEventListener('click', async () => {
        const btn = document.getElementById('refreshStatsBtn');
        const result = document.getElementById('refreshResult');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> åŠ è½½ä¸­...';
        
        try {
            const response = await fetch('/api/stats/');
            const data = await response.json();
            
            if (response.ok) {
                document.getElementById('stat-couples').textContent = data.total_couples || 0;
                document.getElementById('stat-rewards').textContent = data.total_rewards || 0;
                document.getElementById('stat-points').textContent = data.total_points || 0;
                document.getElementById('stat-exchanges').textContent = data.total_exchanges || 0;
                document.getElementById('lastUpdate').textContent = data.last_updated || 'æœªçŸ¥';
                
                result.innerHTML = '<div class="message message-success">âœ… ç»Ÿè®¡æ•°æ®å·²åˆ·æ–°</div>';
            } else {
                result.innerHTML = '<div class="message message-error">âŒ åˆ·æ–°å¤±è´¥</div>';
            }
        } catch (error) {
            result.innerHTML = `<div class="message message-error">âŒ é”™è¯¯: ${error.message}</div>`;
        }
        
        btn.disabled = false;
        btn.innerHTML = 'ğŸ“Š åˆ·æ–°ç»Ÿè®¡';
    });

    // åˆ›å»ºå¤‡ä»½
    document.getElementById('createBackupBtn').addEventListener('click', async () => {
        const btn = document.getElementById('createBackupBtn');
        const result = document.getElementById('backupResult');
        
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> åˆ›å»ºä¸­...';
        
        try {
            const response = await fetch('/api/backups/', { method: 'POST' });
            const data = await response.json();
            
            if (response.ok) {
                result.innerHTML = `<div class="message message-success">âœ… ${data.message}</div>`;
                loadBackupsList();
            } else {
                result.innerHTML = `<div class="message message-error">âŒ ${data.detail || 'å¤‡ä»½å¤±è´¥'}</div>`;
            }
        } catch (error) {
            result.innerHTML = `<div class="message message-error">âŒ é”™è¯¯: ${error.message}</div>`;
        }
        
        btn.disabled = false;
        btn.innerHTML = 'ğŸ’¾ åˆ›å»ºå¤‡ä»½';
    });

    // åŠ è½½å¤‡ä»½åˆ—è¡¨
    async function loadBackupsList() {
        const list = document.getElementById('backupsList');
        
        try {
            const response = await fetch('/api/backups/');
            const data = await response.json();
            
            if (response.ok && data.backups && data.backups.length > 0) {
                list.innerHTML = data.backups.map(backup => {
                    const filename = backup.split('/').pop();
                    return `
                        <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px; font-size: 0.85rem; color: var(--text-light);">
                            ğŸ“„ ${filename}
                        </div>
                    `;
                }).join('');
            } else {
                list.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">æš‚æ— å¤‡ä»½æ–‡ä»¶</p>';
            }
        } catch (error) {
            list.innerHTML = '<p style="color: var(--text-light); font-size: 0.9rem;">æ— æ³•åŠ è½½å¤‡ä»½åˆ—è¡¨</p>';
        }
    }

    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    document.addEventListener('DOMContentLoaded', () => {
        checkBackendStatus();
        loadBackupsList();
    });
</script>
{% endblock %}
